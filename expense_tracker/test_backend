from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.uix.button import Button
from kivy.uix.filechooser import FileChooserIconView
from kivy.uix.popup import Popup
from expense_logic import load_expenses, add_expense, get_category_totals, chatbot_suggestion, visualize_expenses
import io
from kivy.uix.image import Image
from kivy.core.image import Image as CoreImage
import matplotlib.pyplot as plt


class ExpenseTrackerUI(BoxLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = "vertical"  # Stack widgets vertically

        self.df = load_expenses()  # Load expenses from CSV (backend)

        # Label to display expense data
        self.lbl = Label(text=self.df.to_string(index=False), size_hint_y=None, height=300)
        self.add_widget(self.lbl)

        # Input fields for adding expenses
        self.date_input = TextInput(hint_text="Date YYYY-MM-DD", multiline=False)
        self.cat_input = TextInput(hint_text="Category", multiline=False)
        self.amount_input = TextInput(hint_text="Amount", multiline=False, input_filter="float")
        self.desc_input = TextInput(hint_text="Description", multiline=False)

        self.add_widget(self.date_input)
        self.add_widget(self.cat_input)
        self.add_widget(self.amount_input)
        self.add_widget(self.desc_input)

        # Buttons for actions
        self.add_widget(Button(text="Add Expense", on_press=self.add_expense))          # Add expense
        self.add_widget(Button(text="Upload CSV", on_press=self.upload_csv))            # Upload CSV file
        self.add_widget(Button(text="Show Totals", on_press=self.show_totals))          # Show category totals
        self.add_widget(Button(text="Chatbot Suggestion", on_press=self.show_suggestion)) # Chatbot tips
        self.add_widget(Button(text="Show Graph", on_press=self.show_graph))            # Show expense graph

        # Status label for messages
        self.status = Label(text="Status: Ready", size_hint_y=None, height=30)
        self.add_widget(self.status)

    def add_expense(self, _):
        """Add a new expense from inputs."""
        try:
            self.df = add_expense(self.df,
                                  self.date_input.text,
                                  self.cat_input.text,
                                  float(self.amount_input.text or 0),
                                  self.desc_input.text)
            self.lbl.text = self.df.to_string(index=False)  # Update table
            self.status.text = "Expense added!"
        except Exception as e:
            self.status.text = f"Error: {e}"

    def upload_csv(self, _):
        """Open file chooser popup to select a CSV file."""
        chooser = FileChooserIconView()
        popup = Popup(title="Select CSV", content=chooser, size_hint=(0.9, 0.9))
        chooser.bind(on_submit=lambda chooser, selection, touch: self.load_csv(selection, popup))
        popup.open()

    def load_csv(self, selection, popup):
        """Load selected CSV file into the dataframe."""
        if selection:
            try:
                import pandas as pd
                self.df = pd.read_csv(selection[0])
                self.lbl.text = self.df.to_string(index=False)  # Update display
                self.status.text = "CSV loaded successfully!"
            except Exception as e:
                self.status.text = f"Error loading CSV: {e}"
        popup.dismiss()

    def show_totals(self, _):
        """Display category totals."""
        self.lbl.text = get_category_totals(self.df).to_string(index=False)

    def show_suggestion(self, _):
        """Show chatbot-style spending suggestions."""
        self.lbl.text = chatbot_suggestion(self.df)

    def show_graph(self, _):
        """Generate and display expense graph."""
        fig = visualize_expenses(self.df)
        if fig:
            buf = io.BytesIO()
            fig.savefig(buf, format="png")  # Save plot to buffer
            buf.seek(0)
            plt.close(fig)

            popup = Popup(title="Expense Graph", size_hint=(0.9, 0.9))
            img = Image()
            core_img = CoreImage(buf, ext="png")  # Load image from buffer
            img.texture = core_img.texture
            popup.add_widget(img)
            popup.open()
        else:
            self.status.text = "No data to graph."


class Ur_Expense(App):
    def build(self):
        """Build the main app UI."""
        return ExpenseTrackerUI()


if __name__ == "__main__":
    Ur_Expense().run()  # Run the Kivy app
